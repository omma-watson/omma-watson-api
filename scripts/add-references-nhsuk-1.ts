import { VercelPostgres } from '@langchain/community/vectorstores/vercel_postgres';

import { embeddings, vectorstoreConfig } from '@/ai/constants';

const nhsukDocs = `
# 임신 중 식품 섭취 가이드

## 치즈, 우유 및 기타 유제품

### 섭취 가능한 음식
- 살균된 우유, 요구르트, 크림, 아이스크림
- 살균 또는 비살균 경질 치즈 (체다, 그뤼에르, 파르메산 등)
- 살균된 준경질 치즈 (에담 등)
- 살균된 연질 치즈 (코티지 치즈, 모짜렐라, 페타, 크림 치즈, 파니르, 리코타, 할루미, 외피(껍질)가 없는 염소 치즈, 가공 치즈 스프레드)
- 끓을 때까지 조리된 연질 또는 블루 치즈 (살균 또는 비살균)

### 피해야 할 음식
- 비살균 우유로 만든 기타 식품 (예: 부드러운 숙성 염소 치즈)
- 외부에 흰색 코팅이 있는 살균 또는 비살균 곰팡이 숙성 연질 치즈 (브리, 카망베르, 셰브르 등. 단, 끓을 때까지 조리한 경우 제외)
- 살균 또는 비살균 연질 블루 치즈 (덴마크 블루, 고르곤졸라, 로크포르 등. 단, 끓을 때까지 조리한 경우 제외)
- 비살균 우유, 염소 우유, 양 우유 또는 크림

### 이유
비살균 또는 부드럽게 숙성된 유제품에 리스테리아 균이 있을 수 있습니다. 이는 리스테리아증을 유발할 수 있으며, 유산, 사산, 또는 신생아의 심각한 질병을 초래할 수 있습니다. 외부에 흰색 코팅이 있는 연질 치즈는 수분이 더 많아 박테리아가 자라기 쉽습니다. 치즈를 끓을 때까지 조리하면 박테리아를 죽여 리스테리아증의 위험을 줄일 수 있습니다.

## 육류 및 가금류

### 섭취 가능한 음식
- 완전히 익힌 닭고기, 돼지고기, 소고기 (핑크색이나 피가 없어야 함. 특히 가금류, 돼지고기, 소시지, 햄버거는 주의 필요)
- 미리 포장된 차가운 고기 (햄, 콘비프 등)

### 주의가 필요한 음식
- 살라미, 페퍼로니, 초리조, 프로슈토 등의 차가운 숙성 고기 (완전히 조리하지 않은 경우)

### 피해야 할 음식
- 생고기나 덜 익은 고기
- 간과 간으로 만든 제품
- 모든 종류의 파테 (채식 파테 포함)
- 거위, 자고새, 꿩 등의 사냥한 고기

### 이유
생고기나 덜 익은 고기를 먹으면 톡소플라스마증에 걸릴 위험이 있어 유산의 원인이 될 수 있습니다. 숙성 고기는 조리되지 않아 톡소플라스마증을 유발하는 기생충이 있을 수 있습니다. 간과 간 제품에는 비타민 A가 많아 태아에게 해로울 수 있습니다. 사냥한 고기에는 납 탄환이 포함되어 있을 수 있습니다.

## 달걀

### 섭취 가능한 음식
- 영국 라이언 마크가 있는 닭 달걀이나 'Laid in Britain' 제도에 따라 생산된 닭 달걀은 생으로, 부분 조리로, 또는 완전 조리해서 섭취 가능
- 영국 라이언 달걀이나 'Laid in Britain' 제도에 따라 생산된 닭 달걀로 만든 생달걀 함유 음식 (무스, 마요네즈 등)
- 영국 라이언 마크가 없거나 'Laid in Britain' 제도에 따라 생산되지 않은 닭 달걀은 완전히 익혀서 섭취
- 오리, 거위, 메추리 달걀 등 다른 모든 달걀은 완전히 익혀서 섭취

### 피해야 할 음식
- 영국 라이언 마크가 없거나 'Laid in Britain' 제도에 따라 생산되지 않은 닭 달걀의 생달걀 또는 부분 조리 달걀
- 오리, 거위, 메추리 달걀의 생달걀 또는 부분 조리 달걀

### 이유
영국 라이언 닭 달걀과 'Laid in Britain' 제도에 따라 생산된 닭 달걀은 살모넬라균 감염 가능성이 낮습니다. 살모넬라균은 태아에게 직접적인 해를 끼치지는 않지만, 임산부에게 식중독을 일으킬 수 있습니다. 영국 라이언 닭 달걀이나 'Laid in Britain' 제도에 따라 생산된 닭 달걀이 아니라면 모든 달걀을 완전히 익혀 먹어야 합니다.

## 생선

### 섭취 가능한 음식
- 조리된 생선과 해산물
- 생선이 완전히 익은 초밥
- 조리된 조개류 (홍합, 랍스터, 게, 새우, 가리비, 조개 등)

### 섭취를 제한해야 할 음식
- 연어, 송어, 고등어, 청어 등의 기름진 생선은 주 2회 이하로 제한
- 참치 스테이크는 주 2회 (조리 후 약 140g 또는 생 170g) 또는 중간 크기 참치 캔 4개 (배출 후 약 140g) 이하로 제한

참고: 참치는 기름진 생선으로 간주되지 않습니다. 따라서 주 2회의 참치 스테이크나 4개의 중간 크기 참치 캔과 함께 2회의 기름진 생선을 섭취할 수 있습니다.

### 피해야 할 음식
- 황새치
- 청새치
- 상어
- 생 조개류
- 차가운 훈제 또는 염장 생선 (훈제 연어나 그라브락스 등. 단, 끓을 때까지 조리한 경우 제외)

### 이유
차가운 훈제나 염장 생선에는 리스테리아 균이 있을 수 있어 리스테리아증을 유발할 수 있습니다. 이는 유산, 사산, 또는 신생아의 심각한 질병을 초래할 수 있습니다. 훈제나 염장 생선을 끓을 때까지 조리하면 박테리아를 죽일 수 있습니다.

참치는 다른 생선보다 수은 함량이 높아 섭취를 제한해야 합니다. 과도한 수은 섭취는 태아에게 해로울 수 있습니다.

기름진 생선에는 다이옥신과 폴리염화비페닐 같은 오염물질이 있을 수 있어 섭취를 제한해야 합니다. 이러한 물질을 과도하게 섭취하면 태아에게 해로울 수 있습니다.

생 조개류에는 해로운 박테리아, 바이러스, 또는 독소가 있을 수 있어 식중독을 유발할 수 있습니다.

## 기타 음식 및 음료

### 카페인
하루 200mg 이하의 카페인 섭취는 가능합니다. 이보다 많은 양을 정기적으로 섭취하면 저체중아 출산 등의 임신 합병증 위험이 증가하고 유산의 위험도 있습니다.

카페인 함량:
- 인스턴트 커피 1잔: 100mg
- 필터 커피 1잔: 140mg
- 홍차 1잔: 75mg (녹차도 비슷한 양의 카페인 함유)
- 콜라 1캔: 40mg
- 에너지 드링크 250ml: 80mg
- 다크 초콜릿 50g: 25mg 미만
- 밀크 초콜릿 50g: 10mg 미만

### 허브차
허브차의 카페인 함량은 브랜드마다 다양합니다. 카페인이 전혀 없는 것부터 꽤 높은 수준의 카페인을 함유한 것까지 다양합니다. 패키지의 성분 표시를 확인하세요. 일부 허브차에 사용되는 허브는 임신 중, 특히 임신 1-12주(첫 삼개월) 동안 많이 섭취하면 위험할 수 있습니다. 일반적으로 임신 중 하루 1-2잔의 허브차는 괜찮습니다.

### 알코올
임신 중 알코올 섭취는 태아에게 장기적인 해를 끼칠 수 있습니다. 임신 중이거나 임신 계획 중이라면 알코올을 전혀 마시지 않는 것이 가장 안전합니다. 이는 태아에 대한 위험을 최소화합니다.

### 감초
감초는 섭취해도 괜찮지만, 감초 뿌리는 피해야 합니다.

### 과일, 채소, 샐러드
과일, 채소, 샐러드에는 토양이 묻어있을 수 있어 주의가 필요합니다. 모든 과일, 채소, 샐러드 재료를 철저히 씻어야 합니다.

### 땅콩
임신 중 땅콩 섭취를 피할 필요는 없습니다. 의료 전문가의 조언이 있거나 견과류 알레르기가 있는 경우에만 땅콩 섭취를 피하세요.

### 비타민
고용량 종합비타민제나 비타민 A가 포함된 보충제는 섭취하지 마세요.
`;

// 마크다운 파싱을 위한 간단한 함수
function parseMarkdown(markdown: string): { text: string; content: string }[] {
  const lines = markdown.split('\n');
  const result: { text: string; content: string }[] = [];
  const stack: { level: number; text: string }[] = [];

  lines.forEach((line) => {
    const match = line.match(/^(#{1,6})\s(.+)$/);
    if (match) {
      const level = match[1].length;
      const text = match[2];

      while (stack.length > 0 && stack[stack.length - 1].level >= level) {
        stack.pop();
      }

      const fullText = [...stack.map((item) => item.text), text].join('-');
      stack.push({ level, text });

      result.push({ text: fullText, content: '' });
    } else if (line.trim() !== '') {
      if (result.length > 0) {
        result[result.length - 1].content += line + '\n';
      }
    }
  });

  return result.filter((v) => !!v.content);
}

async function main() {
  const parsedData = parseMarkdown(nhsukDocs);

  const vectorstore = await VercelPostgres.initialize(embeddings, {
    ...vectorstoreConfig,
    tableName: 'references_vectors',
  });
  console.log(parsedData);

  await vectorstore.addDocuments(
    parsedData.map((item) => ({
      pageContent: item.content,
      metadata: {
        source: '영국 국영의료서비스(NHS) 웹사이트',
        url: 'https://www.nhs.uk/pregnancy/keeping-well/foods-to-avoid',
        id: item.text,
      },
      id: item.text,
    })),
  );

  // console.log('데이터가 성공적으로 벡터스토어에 추가되었습니다.');

  // 벡터스토어 연결 종료
  await vectorstore.end();
}

main().catch(console.error);
